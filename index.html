<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Mensualidades â€” Demo</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-deep:#06080d;--bg-base:#0b0e14;--bg-card:#111520;--bg-card-hover:#161c2a;
  --bg-surface:#1a2133;--bg-input:#0d1019;
  --border:#1e2738;--border-light:#283347;--border-focus:#4f7cff;
  --text-primary:#e8ecf4;--text-secondary:#8492a6;--text-muted:#556275;
  --accent:#4f7cff;--accent-soft:rgba(79,124,255,.12);--accent-glow:rgba(79,124,255,.25);
  --green:#34d399;--green-soft:rgba(52,211,153,.1);--green-border:rgba(52,211,153,.25);
  --amber:#fbbf24;--amber-soft:rgba(251,191,36,.1);--amber-border:rgba(251,191,36,.25);
  --red:#f87171;--red-soft:rgba(248,113,113,.1);--red-border:rgba(248,113,113,.25);
  --purple:#a78bfa;
  --radius:10px;--radius-lg:14px;
  --shadow:0 4px 24px rgba(0,0,0,.35);
  --font:'DM Sans',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
}
html{font-size:14px}
body{font-family:var(--font);background:var(--bg-deep);color:var(--text-primary);overflow:hidden;height:100vh}

/* â•â•â• SCROLLBAR â•â•â• */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

/* â•â•â• LAYOUT â•â•â• */
.app{display:flex;height:100vh}
.sidebar{width:230px;background:var(--bg-base);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;position:relative;overflow:hidden}
.sidebar::before{content:'';position:absolute;top:0;right:0;width:1px;height:100%;background:linear-gradient(180deg,var(--accent-glow),transparent 40%,transparent 60%,var(--accent-glow))}
.main{flex:1;overflow-y:auto;position:relative}
.main-inner{padding:28px 32px;animation:fadeUp .4s ease}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* â•â•â• SIDEBAR â•â•â• */
.logo-area{padding:22px 20px;border-bottom:1px solid var(--border)}
.logo-area h1{font-size:1.15rem;font-weight:700;letter-spacing:-.02em;display:flex;align-items:center;gap:10px}
.logo-area h1 .icon{font-size:1.4rem}
.logo-area p{font-size:.7rem;color:var(--text-muted);margin-top:2px;letter-spacing:.05em;text-transform:uppercase}

.nav{flex:1;padding:12px 10px}
.nav-item{display:flex;align-items:center;gap:11px;padding:10px 14px;border-radius:var(--radius);font-size:.85rem;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all .2s;border:1px solid transparent;margin-bottom:2px;position:relative}
.nav-item:hover{background:var(--bg-card);color:var(--text-primary)}
.nav-item.active{background:var(--accent-soft);color:var(--accent);border-color:rgba(79,124,255,.15);font-weight:600}
.nav-item.active::before{content:'';position:absolute;left:-10px;top:50%;transform:translateY(-50%);width:3px;height:18px;background:var(--accent);border-radius:0 4px 4px 0}
.nav-item svg{width:18px;height:18px;opacity:.7;flex-shrink:0}
.nav-item.active svg{opacity:1}

.sidebar-footer{padding:14px 16px;border-top:1px solid var(--border)}
.conn-status{display:flex;align-items:center;gap:8px;font-size:.72rem;font-weight:500}
.conn-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green)}
.user-info{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid var(--border)}
.user-info .name{font-size:.82rem;font-weight:600}
.user-info .role{font-size:.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-top:1px}
.user-info .logout-btn{width:30px;height:30px;border-radius:var(--radius);border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:.85rem}
.user-info .logout-btn:hover{border-color:var(--red-border);color:var(--red);background:var(--red-soft)}

/* â•â•â• HEADER â•â•â• */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-header h2{font-size:1.55rem;font-weight:700;letter-spacing:-.03em}

/* â•â•â• BUTTONS â•â•â• */
.btn{padding:9px 18px;border-radius:var(--radius);font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;border:1px solid transparent;display:inline-flex;align-items:center;gap:7px;font-family:var(--font)}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 2px 12px var(--accent-glow)}
.btn-primary:hover{box-shadow:0 4px 20px var(--accent-glow);transform:translateY(-1px)}
.btn-secondary{background:var(--bg-surface);color:var(--text-secondary);border-color:var(--border)}
.btn-secondary:hover{background:var(--bg-card-hover);color:var(--text-primary)}
.btn-success{background:rgba(52,211,153,.15);color:var(--green);border-color:var(--green-border)}
.btn-danger{background:var(--red-soft);color:var(--red);border-color:var(--red-border)}
.btn-sm{padding:6px 12px;font-size:.75rem}

/* â•â•â• CARDS â•â•â• */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;transition:border-color .2s}
.card:hover{border-color:var(--border-light)}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px;margin-bottom:26px}
.stat-card{padding:18px 20px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card .label{font-size:.7rem;color:var(--text-muted);font-weight:500;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
.stat-card .value{font-size:1.45rem;font-weight:700;font-family:var(--mono);letter-spacing:-.02em}
.stat-blue::before{background:var(--accent)}.stat-blue .value{color:var(--accent)}
.stat-purple::before{background:var(--purple)}.stat-purple .value{color:var(--purple)}
.stat-green::before{background:var(--green)}.stat-green .value{color:var(--green)}
.stat-amber::before{background:var(--amber)}.stat-amber .value{color:var(--amber)}
.stat-red::before{background:var(--red)}.stat-red .value{color:var(--red)}

/* â•â•â• BADGES â•â•â• */
.badge{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:.7rem;font-weight:600;letter-spacing:.01em}
.badge-ok{background:var(--green-soft);color:var(--green);border:1px solid var(--green-border)}
.badge-warn{background:var(--amber-soft);color:var(--amber);border:1px solid var(--amber-border)}
.badge-late{background:var(--red-soft);color:var(--red);border:1px solid var(--red-border)}
.badge-role{background:var(--accent-soft);color:var(--accent);border:1px solid rgba(79,124,255,.2)}
.badge-role-cobranza{background:rgba(167,139,250,.1);color:var(--purple);border:1px solid rgba(167,139,250,.2)}

/* â•â•â• TABLES â•â•â• */
table{width:100%;border-collapse:collapse}
thead th{font-size:.7rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:.06em;padding:10px 14px;text-align:left;border-bottom:1px solid var(--border)}
thead th.right{text-align:right}
tbody td{padding:12px 14px;border-bottom:1px solid rgba(30,39,56,.5);font-size:.84rem;vertical-align:middle}
tbody td.right{text-align:right}
tbody td.mono{font-family:var(--mono);font-size:.82rem}
tbody tr{transition:background .15s}
tbody tr:hover{background:var(--bg-card-hover)}
tbody tr.clickable{cursor:pointer}

/* â•â•â• INPUTS â•â•â• */
.input{width:100%;padding:10px 13px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:.84rem;font-family:var(--font);outline:none;transition:border-color .2s}
.input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}
.input::placeholder{color:var(--text-muted)}
select.input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23556275' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.search-wrap{position:relative;flex:1}
.search-wrap svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);width:16px;height:16px}
.search-wrap .input{padding-left:38px}
.filter-bar{display:flex;gap:10px;margin-bottom:20px}

/* â•â•â• FORM â•â•â• */
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:.72rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:5px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* â•â•â• MODAL â•â•â• */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-overlay.active{opacity:1;pointer-events:auto}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:28px;width:480px;max-height:85vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.5);transform:scale(.95);transition:transform .25s}
.modal-overlay.active .modal{transform:scale(1)}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
.modal-header h3{font-size:1.1rem;font-weight:700}
.modal-close{width:30px;height:30px;border-radius:var(--radius);border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .2s}
.modal-close:hover{background:var(--red-soft);border-color:var(--red-border);color:var(--red)}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

/* â•â•â• CLIENT ROW â•â•â• */
.client-row{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;cursor:pointer;margin-bottom:6px}
.client-row .name{font-weight:600;font-size:.9rem}
.client-row .meta{display:flex;align-items:center;gap:14px;margin-top:4px;font-size:.75rem;color:var(--text-muted)}
.client-row .meta svg{width:12px;height:12px}

/* â•â•â• ALERT BOX â•â•â• */
.alert-box{border-radius:var(--radius-lg);padding:18px 22px;margin-bottom:20px}
.alert-red{background:rgba(248,113,113,.06);border:1px solid var(--red-border)}
.alert-amber{background:rgba(251,191,36,.05);border:1px solid var(--amber-border)}
.alert-box h4{font-size:.9rem;font-weight:700;display:flex;align-items:center;gap:8px;margin-bottom:12px}
.alert-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(0,0,0,.2);border-radius:var(--radius);margin-bottom:5px;cursor:pointer;transition:background .15s}
.alert-item:hover{background:rgba(0,0,0,.35)}

/* â•â•â• DETAIL VIEW â•â•â• */
.back-btn{display:inline-flex;align-items:center;gap:6px;color:var(--text-muted);font-size:.82rem;cursor:pointer;margin-bottom:16px;transition:color .2s;background:none;border:none;font-family:var(--font)}
.back-btn:hover{color:var(--text-primary)}
.detail-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px}
.detail-info .name-row{display:flex;align-items:center;gap:12px}
.detail-info .name-row h2{font-size:1.5rem;font-weight:700}
.detail-info .meta-row{display:flex;align-items:center;gap:18px;margin-top:8px;font-size:.82rem;color:var(--text-secondary)}
.detail-info .meta-row svg{width:14px;height:14px}
.detail-actions{display:flex;gap:8px}
.debt-banner{background:rgba(248,113,113,.07);border:1px solid var(--red-border);border-radius:var(--radius-lg);padding:14px 20px;margin-bottom:20px;font-size:.85rem}
.debt-banner strong{color:var(--red)}

/* â•â•â• CHART â•â•â• */
.chart-container{height:220px;display:flex;align-items:flex-end;gap:8px;padding:20px 0 0}
.chart-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.chart-bar{width:100%;border-radius:6px 6px 0 0;background:linear-gradient(180deg,var(--accent),rgba(79,124,255,.4));transition:height .6s ease;position:relative}
.chart-bar:hover{background:linear-gradient(180deg,#6b94ff,rgba(79,124,255,.6))}
.chart-label{font-size:.6rem;color:var(--text-muted);text-transform:uppercase}
.chart-value{font-size:.6rem;color:var(--text-secondary);font-family:var(--mono)}

/* â•â•â• LOGIN â•â•â• */
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg-deep);position:relative;overflow:hidden}
.login-screen::before{content:'';position:absolute;top:-200px;right:-200px;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,var(--accent-glow),transparent 70%);pointer-events:none}
.login-box{width:360px;text-align:center}
.login-box .logo{font-size:3.5rem;margin-bottom:12px;display:block}
.login-box h1{font-size:1.6rem;font-weight:700;margin-bottom:4px}
.login-box .sub{color:var(--text-muted);font-size:.82rem;margin-bottom:28px}
.login-card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:28px;text-align:left}

/* â•â•â• TABS â•â•â• */
.tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg-base);border-radius:var(--radius);padding:3px;width:fit-content}
.tab{padding:7px 16px;border-radius:7px;font-size:.78rem;font-weight:500;color:var(--text-muted);cursor:pointer;transition:all .2s;border:none;background:transparent;font-family:var(--font)}
.tab.active{background:var(--bg-card);color:var(--text-primary);box-shadow:0 2px 8px rgba(0,0,0,.2)}

/* â•â•â• ANIMATIONS â•â•â• */
.stagger>*{opacity:0;animation:fadeUp .4s ease forwards}
.stagger>*:nth-child(1){animation-delay:.05s}.stagger>*:nth-child(2){animation-delay:.1s}
.stagger>*:nth-child(3){animation-delay:.15s}.stagger>*:nth-child(4){animation-delay:.2s}
.stagger>*:nth-child(5){animation-delay:.25s}.stagger>*:nth-child(6){animation-delay:.3s}

/* â•â•â• HIDDEN â•â•â• */
.view{display:none}.view.active{display:block}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <span class="logo">ğŸ’°</span>
    <h1>Mensualidades</h1>
    <p class="sub">Sistema de GestiÃ³n</p>
    <div class="login-card">
      <div class="form-group">
        <label class="form-label">Usuario</label>
        <input id="loginUser" class="input" placeholder="Ingresa tu usuario" value="admin">
      </div>
      <div class="form-group">
        <label class="form-label">ContraseÃ±a</label>
        <input id="loginPass" type="password" class="input" placeholder="Ingresa tu contraseÃ±a" value="admin123">
      </div>
      <div id="loginError" style="display:none;background:var(--red-soft);border:1px solid var(--red-border);border-radius:var(--radius);padding:8px 12px;margin-bottom:14px;font-size:.8rem;color:var(--red)"></div>
      <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:6px" onclick="doLogin()">Iniciar SesiÃ³n</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appScreen" class="app" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo-area">
      <h1><span class="icon">ğŸ’°</span> Mensualidades</h1>
      <p>Sistema de GestiÃ³n</p>
    </div>
    <nav class="nav" id="navMenu"></nav>
    <div class="sidebar-footer">
      <div class="conn-status"><span class="conn-dot"></span> Conectado al servidor</div>
    </div>
    <div class="user-info">
      <div><div class="name" id="userName"></div><div class="role" id="userRole"></div></div>
      <button class="logout-btn" onclick="doLogout()" title="Cerrar sesiÃ³n">â»</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <div class="main-inner" id="mainContent">

      <!-- â•â•â• DASHBOARD â•â•â• -->
      <div id="view-dashboard" class="view active">
        <div class="page-header"><h2>Dashboard</h2></div>
        <div class="stat-grid stagger" id="dashStats"></div>
        <div id="dashMorosos"></div>
        <div id="dashProximos"></div>
        <div class="card" style="margin-top:20px" id="dashTotals"></div>
      </div>

      <!-- â•â•â• CLIENTES â•â•â• -->
      <div id="view-clients" class="view">
        <div class="page-header">
          <h2>Clientes</h2>
          <button class="btn btn-primary" onclick="openModal('addClient')">ï¼‹ Nuevo Cliente</button>
        </div>
        <div class="filter-bar">
          <div class="search-wrap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input id="clientSearch" class="input" placeholder="Buscar por nombre o telÃ©fono..." oninput="renderClients()">
          </div>
          <select id="clientFilter" class="input" style="width:170px" onchange="renderClients()">
            <option value="all">Todos</option>
            <option value="al_corriente">Al corriente</option>
            <option value="proximo">PrÃ³ximo</option>
            <option value="atrasado">Atrasado</option>
          </select>
        </div>
        <div id="clientList"></div>
      </div>

      <!-- â•â•â• DETALLE CLIENTE â•â•â• -->
      <div id="view-client-detail" class="view">
        <div id="clientDetail"></div>
      </div>

      <!-- â•â•â• PAGOS â•â•â• -->
      <div id="view-payments" class="view">
        <div class="page-header"><h2>Historial de Pagos</h2></div>
        <div class="filter-bar" style="align-items:center">
          <span style="font-size:.75rem;color:var(--text-muted)">ğŸ“…</span>
          <input type="date" class="input" style="width:155px" value="2026-02-01" onchange="renderPayments()">
          <span style="font-size:.82rem;color:var(--text-muted)">a</span>
          <input type="date" class="input" style="width:155px" value="2026-02-12" onchange="renderPayments()">
          <div style="margin-left:auto;display:flex;gap:16px;font-size:.82rem" id="paymentTotals"></div>
        </div>
        <div class="card" id="paymentTable"></div>
      </div>

      <!-- â•â•â• REPORTES â•â•â• -->
      <div id="view-reports" class="view">
        <div class="page-header"><h2>Reportes</h2></div>
        <div class="stat-grid stagger" id="reportStats"></div>
        <div class="card" style="margin-bottom:20px">
          <h4 style="margin-bottom:16px;font-size:.95rem;font-weight:700">Ingresos mensuales â€” Ãºltimos 12 meses</h4>
          <div class="chart-container" id="revenueChart"></div>
        </div>
        <div class="card" id="morosoTable"></div>
      </div>

      <!-- â•â•â• USUARIOS â•â•â• -->
      <div id="view-users" class="view">
        <div class="page-header">
          <h2>Usuarios</h2>
          <button class="btn btn-primary" onclick="openModal('addUser')">ï¼‹ Nuevo Usuario</button>
        </div>
        <div class="card" id="userList"></div>
      </div>

      <!-- â•â•â• AJUSTES â•â•â• -->
      <div id="view-settings" class="view">
        <div class="page-header"><h2>Ajustes</h2></div>
        <div class="card" style="max-width:480px" id="settingsForm"></div>
      </div>

    </div>
  </main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="modalTitle"></h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOCK DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const USERS = [
  {id:1,nombre:"Administrador",username:"admin",password:"admin123",rol:"ADMIN",activo:true},
  {id:2,nombre:"MarÃ­a LÃ³pez",username:"cobranza1",password:"cobro123",rol:"COBRANZA",activo:true},
  {id:3,nombre:"Carlos Ruiz",username:"cobranza2",password:"cobro123",rol:"COBRANZA",activo:true},
];

const CLIENTS = [
  {id:1,nombre:"Juan PÃ©rez GarcÃ­a",telefono:"646-123-4567",mensualidad:1500,moneda:"MXN",fecha_inicio:"2025-06-01",dia_corte:1,pagados:8,estado:"al_corriente"},
  {id:2,nombre:"Ana MarÃ­a Torres",telefono:"646-234-5678",mensualidad:2000,moneda:"MXN",fecha_inicio:"2025-03-15",dia_corte:15,pagados:11,estado:"al_corriente"},
  {id:3,nombre:"Roberto SÃ¡nchez",telefono:"646-345-6789",mensualidad:150,moneda:"USD",fecha_inicio:"2025-08-01",dia_corte:1,pagados:4,estado:"atrasado",debe:2},
  {id:4,nombre:"Laura Mendoza Ruiz",telefono:"646-456-7890",mensualidad:1800,moneda:"MXN",fecha_inicio:"2025-05-01",dia_corte:5,pagados:8,estado:"proximo",debe:1},
  {id:5,nombre:"Francisco JimÃ©nez",telefono:"646-567-8901",mensualidad:200,moneda:"USD",fecha_inicio:"2025-07-01",dia_corte:1,pagados:5,estado:"atrasado",debe:3},
  {id:6,nombre:"Patricia Vega Luna",telefono:"646-678-9012",mensualidad:2500,moneda:"MXN",fecha_inicio:"2025-01-01",dia_corte:1,pagados:13,estado:"al_corriente"},
  {id:7,nombre:"Miguel Ãngel Duarte",telefono:"646-789-0123",mensualidad:1200,moneda:"MXN",fecha_inicio:"2025-09-01",dia_corte:10,pagados:5,estado:"al_corriente"},
  {id:8,nombre:"Gabriela Flores",telefono:"646-890-1234",mensualidad:1000,moneda:"MXN",fecha_inicio:"2025-04-01",dia_corte:1,pagados:9,estado:"proximo",debe:1},
  {id:9,nombre:"Alejandro RÃ­os",telefono:"646-901-2345",mensualidad:175,moneda:"USD",fecha_inicio:"2025-10-01",dia_corte:15,pagados:3,estado:"atrasado",debe:1},
  {id:10,nombre:"Diana Castro Ortiz",telefono:"646-012-3456",mensualidad:3000,moneda:"MXN",fecha_inicio:"2025-02-01",dia_corte:1,pagados:12,estado:"al_corriente"},
];

const PAYMENTS = [
  {id:1,client:"Juan PÃ©rez GarcÃ­a",client_id:1,monto:1500,moneda:"MXN",recargo:0,metodo:"Efectivo",fecha:"2026-02-01",mes:"febrero 2026",user:"MarÃ­a LÃ³pez"},
  {id:2,client:"Ana MarÃ­a Torres",client_id:2,monto:2000,moneda:"MXN",recargo:0,metodo:"Transferencia",fecha:"2026-02-02",mes:"febrero 2026",user:"MarÃ­a LÃ³pez"},
  {id:3,client:"Patricia Vega Luna",client_id:6,monto:2500,moneda:"MXN",recargo:0,metodo:"Efectivo",fecha:"2026-02-03",mes:"febrero 2026",user:"Carlos Ruiz"},
  {id:4,client:"Diana Castro Ortiz",client_id:10,monto:3000,moneda:"MXN",recargo:0,metodo:"Tarjeta",fecha:"2026-02-04",mes:"febrero 2026",user:"MarÃ­a LÃ³pez"},
  {id:5,client:"Miguel Ãngel Duarte",client_id:7,monto:1200,moneda:"MXN",recargo:0,metodo:"Efectivo",fecha:"2026-02-05",mes:"febrero 2026",user:"Carlos Ruiz"},
  {id:6,client:"Juan PÃ©rez GarcÃ­a",client_id:1,monto:1500,moneda:"MXN",recargo:0,metodo:"Transferencia",fecha:"2026-01-03",mes:"enero 2026",user:"MarÃ­a LÃ³pez"},
  {id:7,client:"Roberto SÃ¡nchez",client_id:3,monto:150,moneda:"USD",recargo:7.5,metodo:"Efectivo",fecha:"2026-01-10",mes:"noviembre 2025",user:"Carlos Ruiz"},
  {id:8,client:"Francisco JimÃ©nez",client_id:5,monto:200,moneda:"USD",recargo:10,metodo:"Transferencia",fecha:"2026-01-15",mes:"octubre 2025",user:"MarÃ­a LÃ³pez"},
];

const CLIENT_PAYMENTS = {
  1: [
    {fecha:"2026-02-01",mes:"febrero 2026",monto:1500,moneda:"MXN",recargo:0,metodo:"Efectivo",user:"MarÃ­a LÃ³pez"},
    {fecha:"2026-01-03",mes:"enero 2026",monto:1500,moneda:"MXN",recargo:0,metodo:"Transferencia",user:"MarÃ­a LÃ³pez"},
    {fecha:"2025-12-02",mes:"diciembre 2025",monto:1500,moneda:"MXN",recargo:0,metodo:"Efectivo",user:"Carlos Ruiz"},
    {fecha:"2025-11-04",mes:"noviembre 2025",monto:1500,moneda:"MXN",recargo:0,metodo:"Efectivo",user:"MarÃ­a LÃ³pez"},
  ],
  3: [
    {fecha:"2026-01-10",mes:"noviembre 2025",monto:150,moneda:"USD",recargo:7.5,metodo:"Efectivo",user:"Carlos Ruiz"},
    {fecha:"2025-12-08",mes:"octubre 2025",monto:150,moneda:"USD",recargo:0,metodo:"Transferencia",user:"MarÃ­a LÃ³pez"},
    {fecha:"2025-11-05",mes:"septiembre 2025",monto:150,moneda:"USD",recargo:0,metodo:"Efectivo",user:"Carlos Ruiz"},
    {fecha:"2025-10-03",mes:"agosto 2025",monto:150,moneda:"USD",recargo:0,metodo:"Efectivo",user:"MarÃ­a LÃ³pez"},
  ],
};

const MONTHLY_REVENUE = [
  {label:"Mar 25",total:12500},{label:"Abr",total:18200},{label:"May",total:22400},
  {label:"Jun",total:19800},{label:"Jul",total:25100},{label:"Ago",total:28300},
  {label:"Sep",total:24600},{label:"Oct",total:31200},{label:"Nov",total:27800},
  {label:"Dic",total:35400},{label:"Ene 26",total:29100},{label:"Feb",total:11700},
];

const SETTINGS = {porcentaje_recargo:5,dias_gracia:5,tipo_cambio:17.5,nombre:"Mi Negocio"};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let currentView = "dashboard";
let selectedClientId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt = (n,c="MXN") => new Intl.NumberFormat("es-MX",{style:"currency",currency:c}).format(n);
const fmtDate = d => new Date(d+"T12:00:00").toLocaleDateString("es-MX",{day:"numeric",month:"short",year:"numeric"});

function statusBadge(s){
  const m={al_corriente:["Al corriente","badge-ok","âœ“"],proximo:["PrÃ³ximo a vencer","badge-warn","âš "],atrasado:["Atrasado","badge-late","âœ•"]};
  const[l,c,i]=m[s]||m.al_corriente;
  return `<span class="badge ${c}">${i} ${l}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin(){
  const u=document.getElementById("loginUser").value.trim();
  const p=document.getElementById("loginPass").value;
  const user=USERS.find(x=>x.username===u&&x.password===p);
  if(!user){
    const e=document.getElementById("loginError");e.style.display="block";e.textContent="Credenciales invÃ¡lidas";return;
  }
  currentUser=user;
  document.getElementById("loginScreen").style.display="none";
  document.getElementById("appScreen").style.display="flex";
  document.getElementById("userName").textContent=user.nombre;
  document.getElementById("userRole").textContent=user.rol;
  buildNav();
  navigateTo("dashboard");
}

function doLogout(){
  currentUser=null;
  document.getElementById("appScreen").style.display="none";
  document.getElementById("loginScreen").style.display="flex";
  document.getElementById("loginError").style.display="none";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NAV=[
  {id:"dashboard",label:"Dashboard",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>'},
  {id:"clients",label:"Clientes",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'},
  {id:"payments",label:"Pagos",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>'},
  {id:"reports",label:"Reportes",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',admin:true},
  {id:"users",label:"Usuarios",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="m22 2-5 5m0-5 5 5"/></svg>',admin:true},
  {id:"settings",label:"Ajustes",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'},
];

function buildNav(){
  const isAdmin=currentUser?.rol==="ADMIN";
  document.getElementById("navMenu").innerHTML=NAV
    .filter(n=>!n.admin||isAdmin)
    .map(n=>`<div class="nav-item${n.id===currentView?" active":""}" onclick="navigateTo('${n.id}')">${n.icon}<span>${n.label}</span></div>`)
    .join("");
}

function navigateTo(view){
  currentView=view;
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  const el=document.getElementById("view-"+view);
  if(el){el.classList.add("active");el.querySelector(".main-inner")?.scrollTo(0,0)}
  buildNav();
  // Re-trigger animation
  const inner=document.querySelector(".main-inner");
  inner.style.animation="none";inner.offsetHeight;inner.style.animation="fadeUp .4s ease";
  // Render
  if(view==="dashboard")renderDashboard();
  if(view==="clients")renderClients();
  if(view==="client-detail")renderClientDetail();
  if(view==="payments")renderPayments();
  if(view==="reports")renderReports();
  if(view==="users")renderUsers();
  if(view==="settings")renderSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const febPayments=PAYMENTS.filter(p=>p.fecha.startsWith("2026-02"));
  const mxn=febPayments.filter(p=>p.moneda==="MXN").reduce((s,p)=>s+p.monto,0);
  const usd=febPayments.filter(p=>p.moneda==="USD").reduce((s,p)=>s+p.monto,0);
  const ok=CLIENTS.filter(c=>c.estado==="al_corriente").length;
  const warn=CLIENTS.filter(c=>c.estado==="proximo").length;
  const late=CLIENTS.filter(c=>c.estado==="atrasado").length;

  document.getElementById("dashStats").innerHTML=[
    {l:"Cobrado feb (MXN)",v:fmt(mxn),c:"stat-blue"},
    {l:"Cobrado feb (USD)",v:fmt(usd,"USD"),c:"stat-purple"},
    {l:"Clientes activos",v:CLIENTS.length,c:"stat-blue"},
    {l:"Al corriente",v:ok,c:"stat-green"},
    {l:"PrÃ³ximos a vencer",v:warn,c:"stat-amber"},
    {l:"Atrasados",v:late,c:"stat-red"},
  ].map(s=>`<div class="card stat-card ${s.c}"><div class="label">${s.l}</div><div class="value">${s.v}</div></div>`).join("");

  const morosos=CLIENTS.filter(c=>c.estado==="atrasado");
  document.getElementById("dashMorosos").innerHTML=morosos.length?`
    <div class="alert-box alert-red">
      <h4 style="color:var(--red)">âœ• Clientes con atraso (${morosos.length})</h4>
      ${morosos.map(c=>`
        <div class="alert-item" onclick="showClientDetail(${c.id})">
          <div><span style="font-weight:600;font-size:.85rem">${c.nombre}</span><span style="color:var(--text-muted);font-size:.75rem;margin-left:10px">${c.telefono}</span></div>
          <div style="text-align:right"><span style="color:var(--red);font-weight:700;font-size:.85rem">${c.debe} ${c.debe===1?"mes":"meses"}</span><span style="color:var(--text-muted);font-size:.75rem;margin-left:8px">${fmt(c.debe*c.mensualidad,c.moneda)}</span></div>
        </div>`).join("")}
    </div>`:"";

  const proximos=CLIENTS.filter(c=>c.estado==="proximo");
  document.getElementById("dashProximos").innerHTML=proximos.length?`
    <div class="alert-box alert-amber">
      <h4 style="color:var(--amber)">âš  PrÃ³ximos a vencer (${proximos.length})</h4>
      ${proximos.map(c=>`
        <div class="alert-item" onclick="showClientDetail(${c.id})">
          <div><span style="font-weight:600;font-size:.85rem">${c.nombre}</span><span style="color:var(--text-muted);font-size:.75rem;margin-left:10px">${c.telefono}</span></div>
          ${statusBadge("proximo")}
        </div>`).join("")}
    </div>`:"";

  const totalMXN=PAYMENTS.filter(p=>p.moneda==="MXN").reduce((s,p)=>s+p.monto,0);
  const totalUSD=PAYMENTS.filter(p=>p.moneda==="USD").reduce((s,p)=>s+p.monto,0);
  document.getElementById("dashTotals").innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div><p style="font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em">Total cobrado histÃ³rico (MXN)</p><p style="font-size:1.3rem;font-weight:700;color:var(--accent);margin-top:6px;font-family:var(--mono)">${fmt(totalMXN)}</p></div>
      <div><p style="font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em">Total cobrado histÃ³rico (USD)</p><p style="font-size:1.3rem;font-weight:700;color:var(--purple);margin-top:6px;font-family:var(--mono)">${fmt(totalUSD,"USD")}</p></div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: CLIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderClients(){
  const search=document.getElementById("clientSearch")?.value?.toLowerCase()||"";
  const filter=document.getElementById("clientFilter")?.value||"all";
  const list=CLIENTS.filter(c=>{
    const ms=c.nombre.toLowerCase().includes(search)||c.telefono.includes(search);
    const mf=filter==="all"||c.estado===filter;
    return ms&&mf;
  });
  document.getElementById("clientList").innerHTML=list.length?list.map(c=>`
    <div class="card client-row" onclick="showClientDetail(${c.id})">
      <div>
        <div style="display:flex;align-items:center;gap:10px">
          <span class="name">${c.nombre}</span>
          ${statusBadge(c.estado)}
        </div>
        <div class="meta">
          <span>ğŸ“ ${c.telefono}</span>
          <span>${fmt(c.mensualidad,c.moneda)}/mes</span>
          <span>Pagados: ${c.pagados} | Debe: ${c.debe||0}</span>
        </div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
    </div>`).join(""):`<p style="text-align:center;color:var(--text-muted);padding:40px">Sin resultados.</p>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: CLIENT DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showClientDetail(id){
  selectedClientId=id;
  navigateTo("client-detail");
}

function renderClientDetail(){
  const c=CLIENTS.find(x=>x.id===selectedClientId);
  if(!c)return;
  const debe=c.debe||0;
  const esperados=c.pagados+debe;
  const recargo=debe>0?c.mensualidad*(SETTINGS.porcentaje_recargo/100)*debe:0;
  const totalDeuda=debe*c.mensualidad+recargo;
  const payments=CLIENT_PAYMENTS[c.id]||[];
  const isAdmin=currentUser?.rol==="ADMIN";

  document.getElementById("clientDetail").innerHTML=`
    <button class="back-btn" onclick="navigateTo('clients')">â† Volver a clientes</button>
    <div class="detail-header">
      <div class="detail-info">
        <div class="name-row"><h2>${c.nombre}</h2>${statusBadge(c.estado)}</div>
        <div class="meta-row">
          <span>ğŸ“ ${c.telefono}</span>
          <span>ğŸ“… Inicio: ${fmtDate(c.fecha_inicio)}</span>
          <span>ğŸ’µ ${fmt(c.mensualidad,c.moneda)}/mes</span>
        </div>
      </div>
      <div class="detail-actions">
        <button class="btn btn-secondary" onclick="openModal('editClient')">âœ Editar</button>
        <button class="btn btn-primary" onclick="openModal('addPayment')">ï¼‹ Registrar Pago</button>
      </div>
    </div>

    <div class="stat-grid stagger">
      <div class="card stat-card stat-green"><div class="label">Meses pagados</div><div class="value">${c.pagados}</div></div>
      <div class="card stat-card stat-blue"><div class="label">Meses esperados</div><div class="value">${esperados}</div></div>
      <div class="card stat-card ${debe>0?"stat-red":"stat-green"}"><div class="label">Meses que debe</div><div class="value">${debe}</div></div>
      <div class="card stat-card stat-amber"><div class="label">Recargo acumulado</div><div class="value">${fmt(recargo,c.moneda)}</div></div>
    </div>

    ${debe>0?`<div class="debt-banner"><strong>Deuda total: ${fmt(totalDeuda,c.moneda)}</strong> <span style="color:var(--text-muted)">(${debe} meses Ã— ${fmt(c.mensualidad,c.moneda)} + ${fmt(recargo,c.moneda)} recargos)</span></div>`:""}

    <div class="card">
      <h4 style="margin-bottom:16px;font-size:.95rem;font-weight:700">Historial de Pagos</h4>
      ${payments.length?`
      <table>
        <thead><tr>
          <th>Fecha</th><th>Mes</th><th class="right">Monto</th><th class="right">Recargo</th><th>MÃ©todo</th><th>RegistrÃ³</th>
          ${isAdmin?'<th></th>':""}
        </tr></thead>
        <tbody>
          ${payments.map(p=>`<tr>
            <td>${fmtDate(p.fecha)}</td>
            <td style="color:var(--text-secondary)">${p.mes}</td>
            <td class="right mono" style="font-weight:600">${fmt(p.monto,p.moneda)}</td>
            <td class="right" style="color:var(--text-muted)">${p.recargo>0?fmt(p.recargo,p.moneda):"â€”"}</td>
            <td style="color:var(--text-secondary)">${p.metodo}</td>
            <td style="color:var(--text-muted)">${p.user}</td>
            ${isAdmin?'<td class="right"><button class="btn btn-danger btn-sm" style="padding:4px 8px;font-size:.7rem">ğŸ—‘</button></td>':""}
          </tr>`).join("")}
        </tbody>
      </table>`:`<p style="text-align:center;color:var(--text-muted);padding:30px">Sin pagos registrados</p>`}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: PAYMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPayments(){
  const febPayments=PAYMENTS.filter(p=>p.fecha.startsWith("2026-02"));
  const allP=PAYMENTS;
  const mxn=allP.filter(p=>p.moneda==="MXN").reduce((s,p)=>s+p.monto,0);
  const usd=allP.filter(p=>p.moneda==="USD").reduce((s,p)=>s+p.monto,0);

  document.getElementById("paymentTotals").innerHTML=`
    <span style="color:var(--text-muted)">MXN: <strong style="color:var(--accent)">${fmt(mxn)}</strong></span>
    <span style="color:var(--text-muted)">USD: <strong style="color:var(--purple)">${fmt(usd,"USD")}</strong></span>
    <span style="color:var(--text-muted)">Total: <strong style="color:var(--text-primary)">${allP.length}</strong></span>`;

  document.getElementById("paymentTable").innerHTML=`
    <table>
      <thead><tr><th>Fecha</th><th>Cliente</th><th>Mes</th><th class="right">Monto</th><th class="right">Recargo</th><th>MÃ©todo</th><th>RegistrÃ³</th></tr></thead>
      <tbody>
        ${allP.map(p=>`<tr class="clickable" onclick="showClientDetail(${p.client_id})">
          <td>${fmtDate(p.fecha)}</td>
          <td style="font-weight:600">${p.client}</td>
          <td style="color:var(--text-secondary)">${p.mes}</td>
          <td class="right mono" style="font-weight:600">${fmt(p.monto,p.moneda)}</td>
          <td class="right" style="color:var(--text-muted)">${p.recargo>0?fmt(p.recargo,p.moneda):"â€”"}</td>
          <td style="color:var(--text-secondary)">${p.metodo}</td>
          <td style="color:var(--text-muted)">${p.user}</td>
        </tr>`).join("")}
      </tbody>
    </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReports(){
  const febP=PAYMENTS.filter(p=>p.fecha.startsWith("2026-02"));
  const mxn=febP.filter(p=>p.moneda==="MXN").reduce((s,p)=>s+p.monto,0);
  const usd=febP.filter(p=>p.moneda==="USD").reduce((s,p)=>s+p.monto,0);
  const rec=febP.reduce((s,p)=>s+p.recargo,0);

  document.getElementById("reportStats").innerHTML=[
    {l:"Cobrado MXN (mes)",v:fmt(mxn),c:"stat-blue"},
    {l:"Cobrado USD (mes)",v:fmt(usd,"USD"),c:"stat-purple"},
    {l:"Recargos (mes)",v:fmt(rec),c:"stat-amber"},
    {l:"Pagos del mes",v:febP.length,c:"stat-green"},
  ].map(s=>`<div class="card stat-card ${s.c}"><div class="label">${s.l}</div><div class="value">${s.v}</div></div>`).join("");

  // Chart
  const maxVal=Math.max(...MONTHLY_REVENUE.map(m=>m.total));
  document.getElementById("revenueChart").innerHTML=MONTHLY_REVENUE.map(m=>{
    const h=Math.max(8,(m.total/maxVal)*180);
    return `<div class="chart-bar-wrap">
      <div class="chart-value">${(m.total/1000).toFixed(1)}k</div>
      <div class="chart-bar" style="height:${h}px"></div>
      <div class="chart-label">${m.label}</div>
    </div>`;
  }).join("");

  // Morosos table
  const morosos=CLIENTS.filter(c=>c.estado==="atrasado").map(c=>{
    const recargo=c.mensualidad*(SETTINGS.porcentaje_recargo/100)*(c.debe||0);
    return{...c,recargo,total:(c.debe||0)*c.mensualidad+recargo};
  });

  document.getElementById("morosoTable").innerHTML=`
    <h4 style="margin-bottom:16px;font-size:.95rem;font-weight:700">Clientes morosos (${morosos.length})</h4>
    <table>
      <thead><tr><th>Cliente</th><th>TelÃ©fono</th><th class="right">Meses</th><th class="right">Deuda</th><th class="right">Recargo</th><th class="right">Total</th></tr></thead>
      <tbody>
        ${morosos.map(m=>`<tr>
          <td style="font-weight:600">${m.nombre}</td>
          <td style="color:var(--text-muted)">${m.telefono}</td>
          <td class="right" style="color:var(--red);font-weight:700">${m.debe}</td>
          <td class="right mono">${fmt(m.debe*m.mensualidad,m.moneda)}</td>
          <td class="right" style="color:var(--amber)">${fmt(m.recargo,m.moneda)}</td>
          <td class="right mono" style="color:var(--red);font-weight:700">${fmt(m.total,m.moneda)}</td>
        </tr>`).join("")}
      </tbody>
    </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUsers(){
  document.getElementById("userList").innerHTML=USERS.map(u=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--bg-base);border-radius:var(--radius);margin-bottom:6px;border:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-weight:600;font-size:.88rem">${u.nombre}</span>
        <span style="color:var(--text-muted);font-size:.78rem">@${u.username}</span>
        <span class="badge ${u.rol==="ADMIN"?"badge-role":"badge-role-cobranza"}">${u.rol}</span>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-secondary btn-sm">${u.activo?"âœ“ Activo":"âœ• Inactivo"}</button>
        <button class="btn btn-secondary btn-sm">âœ Editar</button>
      </div>
    </div>`).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(){
  const isAdmin=currentUser?.rol==="ADMIN";
  document.getElementById("settingsForm").innerHTML=`
    <div class="form-group">
      <label class="form-label">Nombre del negocio</label>
      <input class="input" value="${SETTINGS.nombre}" ${isAdmin?"":"disabled"}>
    </div>
    <div class="form-group">
      <label class="form-label">Porcentaje de recargo (%)</label>
      <input class="input" type="number" value="${SETTINGS.porcentaje_recargo}" ${isAdmin?"":"disabled"}>
      <p style="font-size:.72rem;color:var(--text-muted);margin-top:4px">Se aplica por cada mes de atraso sobre el monto de la mensualidad</p>
    </div>
    <div class="form-group">
      <label class="form-label">DÃ­as de gracia</label>
      <input class="input" type="number" value="${SETTINGS.dias_gracia}" ${isAdmin?"":"disabled"}>
      <p style="font-size:.72rem;color:var(--text-muted);margin-top:4px">DÃ­as despuÃ©s del corte antes de marcar como "atrasado"</p>
    </div>
    <div class="form-group">
      <label class="form-label">Tipo de cambio USD â†’ MXN</label>
      <input class="input" type="number" value="${SETTINGS.tipo_cambio}" step="0.01" ${isAdmin?"":"disabled"}>
    </div>
    ${isAdmin?'<button class="btn btn-primary" style="margin-top:8px" onclick="alert(\'Ajustes guardados (demo)\')">Guardar Ajustes</button>'
    :'<p style="font-size:.78rem;color:var(--text-muted);font-style:italic;margin-top:8px">Solo el administrador puede modificar los ajustes.</p>'}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(type){
  const overlay=document.getElementById("modalOverlay");
  const title=document.getElementById("modalTitle");
  const body=document.getElementById("modalBody");

  if(type==="addClient"){
    title.textContent="Nuevo Cliente";
    body.innerHTML=`
      <div class="form-group"><label class="form-label">Nombre completo *</label><input class="input" placeholder="Nombre del cliente"></div>
      <div class="form-group"><label class="form-label">TelÃ©fono</label><input class="input" placeholder="646-123-4567"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Mensualidad *</label><input class="input" type="number" placeholder="0.00"></div>
        <div class="form-group"><label class="form-label">Moneda</label><select class="input"><option value="MXN">MXN â€” Pesos</option><option value="USD">USD â€” DÃ³lares</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Fecha de inicio</label><input class="input" type="date" value="2026-02-12"></div>
        <div class="form-group"><label class="form-label">DÃ­a de corte</label><input class="input" type="number" value="1" min="1" max="28"></div>
      </div>
      <div class="form-group"><label class="form-label">Notas</label><textarea class="input" rows="2" placeholder="Notas opcionales..." style="resize:none"></textarea></div>
      <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="alert('Cliente registrado (demo)');closeModal()">Registrar Cliente</button></div>`;
  }

  if(type==="editClient"){
    const c=CLIENTS.find(x=>x.id===selectedClientId);
    title.textContent="Editar Cliente";
    body.innerHTML=`
      <div class="form-group"><label class="form-label">Nombre</label><input class="input" value="${c?.nombre||""}"></div>
      <div class="form-group"><label class="form-label">TelÃ©fono</label><input class="input" value="${c?.telefono||""}"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Mensualidad</label><input class="input" type="number" value="${c?.mensualidad||""}"></div>
        <div class="form-group"><label class="form-label">Moneda</label><select class="input"><option ${c?.moneda==="MXN"?"selected":""}>MXN</option><option ${c?.moneda==="USD"?"selected":""}>USD</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">DÃ­a de corte</label><input class="input" type="number" value="${c?.dia_corte||1}" min="1" max="28"></div>
      <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="alert('Cliente actualizado (demo)');closeModal()">Guardar Cambios</button></div>`;
  }

  if(type==="addPayment"){
    const c=CLIENTS.find(x=>x.id===selectedClientId);
    title.textContent="Registrar Pago";
    body.innerHTML=`
      <div style="background:var(--accent-soft);border:1px solid rgba(79,124,255,.15);border-radius:var(--radius);padding:10px 14px;margin-bottom:16px;font-size:.82rem">
        <strong>${c?.nombre}</strong> <span style="color:var(--text-muted)">â€” ${fmt(c?.mensualidad||0,c?.moneda||"MXN")}/mes</span>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Monto *</label><input class="input" type="number" value="${c?.mensualidad||""}" step="0.01"></div>
        <div class="form-group"><label class="form-label">Moneda</label><select class="input"><option ${c?.moneda==="MXN"?"selected":""}>MXN</option><option ${c?.moneda==="USD"?"selected":""}>USD</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Mes que corresponde *</label><input class="input" type="date" value="2026-02-01"></div>
        <div class="form-group"><label class="form-label">MÃ©todo de pago</label><select class="input"><option>Efectivo</option><option>Transferencia</option><option>Tarjeta</option><option>Otro</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Recargo</label><input class="input" type="number" value="0" step="0.01"></div>
      <div class="form-group"><label class="form-label">Notas</label><textarea class="input" rows="2" style="resize:none" placeholder="Notas opcionales..."></textarea></div>
      <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-success" onclick="alert('Pago registrado (demo)');closeModal()">Registrar Pago</button></div>`;
  }

  if(type==="addUser"){
    title.textContent="Nuevo Usuario";
    body.innerHTML=`
      <div class="form-group"><label class="form-label">Nombre</label><input class="input" placeholder="Nombre completo"></div>
      <div class="form-group"><label class="form-label">Username</label><input class="input" placeholder="nombre_usuario"></div>
      <div class="form-group"><label class="form-label">ContraseÃ±a</label><input class="input" type="password" placeholder="ContraseÃ±a segura"></div>
      <div class="form-group"><label class="form-label">Rol</label><select class="input"><option value="COBRANZA">Cobranza</option><option value="ADMIN">Administrador</option></select></div>
      <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="alert('Usuario creado (demo)');closeModal()">Crear Usuario</button></div>`;
  }

  overlay.classList.add("active");
}

function closeModal(){
  document.getElementById("modalOverlay").classList.remove("active");
}

// Keyboard
document.addEventListener("keydown",e=>{if(e.key==="Escape")closeModal()});
document.getElementById("loginPass").addEventListener("keydown",e=>{if(e.key==="Enter")doLogin()});
</script>
</body>
</html>
